# NooBaa Non Containerized - Logging

1. [Introduction](#introduction)
2. [NooBaa Service logs](#noobaa-service-logs)
    1. [Journal logs](#journal-logs)
    2. [Rsyslog](#rsyslog) 
        1. [Rsyslog status check](#rsyslog-status-check)
        2. [Logrotate](#logrotate)
            1. [Logrotate automatic rotation](#logrotate-automatic-rotation)
            1. [Manual Logrotate trigerring](#manual-logrotate-triggering)
4. [NooBaa Debug levels](#noobaa-debug-levels)
    1. [Supported log debug levels](#supported-log-debug-levels)
    2. [Debug level Increase](#debug-level-increase)
5. [NooBaa Logs format](#noobaa-logs-format)
6. [Known issues](#known-issues)

## Introduction

This document provides an overview of the logging capabilities within NooBaa, detailing how to configure and utilize logs for monitoring and troubleshooting.

## NooBaa Service Logs

NooBaa service logs are written directly to stderr, syslog, or both.
1. The `journalctl` service watches stderr and writes into `journal`. That internally updates the `/var/log/messages`.
2. Noobaa sends logs to a syslog service such as rsyslog or syslog_ng and writes the logs to `/var/log/noobaa.log` if enabled. We can not have more than one service enabled at a time. It might cause some issues.

### Set log config

Set `LOG_TO_STDERR_ENABLED` property to `true` to  send Noobaa logs to stderr. Noobaa logs will be send to syslog when the property `LOG_TO_SYSLOG_ENABLED` set to `true`.

Default configurations are:
```
LOG_TO_STDERR_ENABLED = true;
LOG_TO_SYSLOG_ENABLED = false;
```

### Journal logs
1. NooBaa service logs -

Run the following command in order to display the NooBaa service logs -

```sh
journalctl -u noobaa.service
```

### Rsyslog

NooBaa logs are configured using rsyslog and logrotate. NooBaa RPM will configure rsyslog and logrotate if both are already running.

#### Rsyslog status check
```
systemctl status rsyslog
```

NooBaa logs are pushed to `/var/log/noobaa.log` and the log is rotated and compressed daily.

The following files contain NooBaa specific configuration for rsyslog and logrotate - 
1. `etc/rsyslog.d/noobaa_syslog.conf`
2. `etc/logrotate.d/noobaa-logrotate` 

Verify the rsyslog and logrotate rpm configuration is complete by checking the files above.

### Logrotate

##### Logrotate automatic rotation

- Logrotate configuration is set up under `etc/logrotate.d/`. 
- Logrotate is called from cron on daily schedule, usually at midnight.
- For acquiring more knowledge on NooBaa events, read - [NooBaa Non Containerized Events](./Events.md).  
##### Manual Logrotate triggering
To rotate the logs manually run -
```
logrotate etc/logrotate.d/noobaa-logrotate
```


## NooBaa Debug levels

### Supported log debug levels

1. `default` - default debugging.
2. `warn` - warning/errors debugging only. 
3. `nsfs` - additional `nsfs` detailed debugging.
4. `all` - all detailed debugging.


### Debug level Increase

Set `NOOBAA_LOG_LEVEL` property in config.json to control the amount of debugging information generated by the application.
For more info about setting custom properties, see - [Non Containerized Config File Customizations](./ConfigFileCustomizations.md)

### NooBaa Logs format
NooBaa logs are formatted with ANSI color codes. </br>
Use the `cat <logfile> | less -R` command in order to display the contents of a log file with pagination and the ability to handle ANSI color codes. 

## How to configure syslog-ng

1. create syslog-ng noobaa specific config file `noobaa-syslog-ng.conf` under `etc/syslog-ng/conf.d/`
```
vi etc/syslog-ng/conf.d/noobaa-syslog-ng.conf 
```
2. update the file with bellow configuration

```
destination d_noobaa_msg { file("/var/log/noobaa.log"); };
destination d_noobaa_event { file("/var/log/noobaa_events.log"); };

filter f_noobaa_msg     { facility(local0); };
filter f_noobaa_event     { facility(local2); };

log { source(s_sys); filter(f_noobaa_msg); destination(d_noobaa_msg); };
log { source(s_sys); filter(f_noobaa_event); destination(d_noobaa_event); };
```
We are creating two new destination one is `d_noobaa_msg`, point to log file `/var/log/noobaa.log` and another one is `d_noobaa_event` , point to log file `/var/log/noobaa_events.log`
Filter  `f_noobaa_msg` and `f_noobaa_event` will filter out only noobaa logs and events log. Last created two source that will filter and log only noobaa normal logs and events to previously added destinations.

3. Update existing filter `f_default` in default syslog-ng `etc/syslog-ng/syslog-ng.conf`  to make sure noobaa logs and event are not send to `/var/log/message` log file.
```
vi etc/syslog-ng/syslog-ng.conf
// update file for filter f_default
filter f_default    { level(info..emerg) and
                        not (facility(mail)
                        or facility(local0)
                        or facility(local2)
                        or facility(authpriv)
                        or facility(cron)); };
```
 Noobaa logs with facility local0 and local2 are excluded from message logs
4. restart syslog-ng
```
systemctl restart syslog-ng
```

### Known issues

1. Missing logs due to systemd-journald log suppression
        `Suppressed 6284127 messages from noobaa.service`
    
    solution :
    * Edit /etc/systemd/journald.conf
    * add below configuration
        ```
        RateLimitInterval=0
        RateLimitBurst=0
        ```
    link : https://my.f5.com/manage/s/article/K70501143

2. Conflicting rsyslog.conf files using the same facility

    NooBaa uses `local0` for debug logs and `local2` for events logs. Conflicts can occur if other services or configurations use the same facilities, leading to log mixing or loss.
    
    To identify conflicts, run:
    ```bash
    grep -r local0 /etc/rsyslog.conf /etc/rsyslog.d/
    grep -r local2 /etc/rsyslog.conf /etc/rsyslog.d/
    ```
    
    Solution:
    * Ensure only NooBaa is configured to use `local0` and `local2` facilities
    * Remove or modify conflicting configurations in other rsyslog files
    * Restart rsyslog service after resolving conflicts 

    Note -
    As for today, one can set the following configurations - 
    ```
    config.DEBUG_FACILITY = 'LOG_LOCAL0';
    config.EVENT_FACILITY = 'LOG_LOCAL2';
    ```
    but it'll change only the node.js layer logs, FS_NAPI layer logs which are very important for debugging are currently written hard coded to `local0` facility. for more info, see - https://github.com/noobaa/noobaa-core/issues/9165.