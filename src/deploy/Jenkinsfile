#!groovyâ€‹
def noobaa_ip = '137.117.41.95'
def values = noobaa_ip.tokenize('.')
def prefix = values[2]+'-'+values[3]
def dataset_size = '5120' // 5 GB of dataset
def start_killing_time = '15' // start killing after 15 minustes
def aging_time = '120' // run for 2 hours
def service = 'azure'
def resource = 'jacky-resources'
def zone = 'eastus'
node('node2') {
    stage('GetTestFromGit') {
        echo 'Checkouting from git!'
        checkout([$class: 'GitSCM', branches: [[name: '*/${branch}']], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[credentialsId: 'bb9a113a-8e3d-49b7-abd7-7ae1fb4d452b', url: 'https://github.com/noobaa/noobaa-core']]])
    }
    stage('NpmInstall') {
        echo 'Installing all needed npm packages!'
        sh returnStatus: true, script: """
              export NVM_DIR=/usr/local/nvm
              . /opt/nvm/nvm.sh
              npm install bluebird lodash winston setimmediate aws-sdk minimist azure dotenv googleapis
        """
    }
    stage('RunningDataSet while machine killing') {
      // Run the maven build
      parallel (
          "dataset": {
            echo 'Running some dataset!'
            sh returnStatus: true, script: """
                export NVM_DIR=/usr/local/nvm
                . /opt/nvm/nvm.sh
                node $WORKSPACE/src/test/qa/dataset.js --server '${noobaa_ip}' --aging_timeout '${aging_time}' --dataset_size '${dataset_size}'
            """
          },
          "machinekill": {
            echo 'Killing some nodes!'
            sh returnStatus: true, script: """
                export NVM_DIR=/usr/local/nvm
                . /opt/nvm/nvm.sh
                cp /usr/local/noobaa/.env $WORKSPACE
                sleep '${start_killing_time}'m
                node $WORKSPACE/src/test/qa/machine_killer.js --service '${service}' --project '${resource}' --zone '${zone}' --prefix '${prefix}' --timeout \$((${aging_time}-${start_killing_time}))
            """
          }
      )
   }
}
