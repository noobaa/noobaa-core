#!/bin/sh

# chkconfig: 345 15 15

. /etc/rc.d/init.d/functions

SUPERVISORD="/usr/bin/supervisord"
PIDFILE="/tmp/supervisord.pid"

start() {
    if [ ! -x "$SUPERVISORD" ]; then
        echo "$SUPERVISORD is not executable."
        exit 1
    fi

    echo "Starting ..."
    ulimit -n 102400; $SUPERVISORD --pidfile $PIDFILE

    return $?
}

stop() {
    echo "Stopping ..."
    local p=$(cat $PIDFILE)
    kill -9 ${p}
    #unlink /tmp/supervisor.sock
    #local pid=$(lsof -i :8080|awk  '{ print $2 }' | sed '1 d')
    #for p in ${pid} ; do
      #kill -9 ${p}
    #done
    [ $? -eq 0 ] && rm -f $PIDFILE
    return $retval
}

case $1 in
    start)
        start
    ;;
    stop)
        stop
    ;;
    restart)
        stop
        sleep 1
        start
    ;;
    *)
        echo "$0 start|stop|restart"
        exit 2
    ;;
esac
